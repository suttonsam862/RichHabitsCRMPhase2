# Ultimate Rebuild & Production Hardening Checklist

## 1) Database Migration
- [ ] Create `db/migrations/2025_08_22_ultimate_rebuild.sql`
- [ ] Add idempotent role seeds
- [ ] Create status_order_items table with seeds
- [ ] Add org table fields (color_palette, universal_discounts)
- [ ] Add contact_user_id to org_sports
- [ ] Convert order status enum to status_code
- [ ] Create SQL helper functions (has_role, is_org_member, etc.)
- [ ] Add org_summary RPC function
- [ ] Create storage bucket and indexes
- [ ] Run migration successfully

## 2) Server Infrastructure
- [ ] Create `server/env.ts` with Zod validation
- [ ] Create `server/lib/http.ts` with response helpers
- [ ] Create `server/lib/log.ts` with Pino configuration
- [ ] Create `server/lib/supabase.ts` with client utilities
- [ ] Create `server/middleware/auth.ts` with requireAuth
- [ ] Update `server/index.ts` with security middleware
- [ ] Restructure `server/routes/index.ts` for v1 API

## 3) Authentication & Authorization
- [ ] Create `server/routes/auth/index.ts` with login/register/logout
- [ ] Implement Supabase Auth integration
- [ ] Add token validation middleware
- [ ] Test protected route enforcement

## 4) API Endpoints
- [ ] Update organizations routes with summary RPC
- [ ] Create users admin endpoints
- [ ] Update orders to use statusCode only
- [ ] Create secure file upload endpoints
- [ ] Standardize all API responses
- [ ] Add input validation with Zod

## 5) Client Routing & Auth
- [ ] Update `client/src/App.tsx` with React Router v6
- [ ] Create `client/src/routes.tsx` with lazy routes
- [ ] Create `client/src/components/ErrorBoundary.tsx`
- [ ] Create `client/src/auth/AuthProvider.tsx`
- [ ] Create `client/src/auth/ProtectedRoute.tsx`
- [ ] Create `client/src/lib/api.ts` unified client
- [ ] Update `client/src/lib/queryClient.ts` configuration

## 6) UI Pages & Components
- [ ] Create auth pages (Login, Register)
- [ ] Create organization pages (List, CreateWizard, Detail)
- [ ] Create user admin pages (UsersPage, EditUserDrawer)
- [ ] Create quotes page stub
- [ ] Create 404 NotFound page
- [ ] Create OrgQuickViewDialog component
- [ ] Create BrandingDropzone component

## 7) Security Hardening
- [ ] Add helmet middleware
- [ ] Configure strict CORS
- [ ] Implement rate limiting
- [ ] Add input validation and sanitization
- [ ] Secure file upload validation
- [ ] Add request ID tracking
- [ ] Implement logging with secret redaction

## 8) Performance Optimization
- [ ] Implement org_summary RPC to eliminate N+1
- [ ] Add database indexes
- [ ] Enable compression middleware
- [ ] Add pagination to list endpoints
- [ ] Implement code splitting and lazy loading

## 9) Configuration & Build
- [ ] Align tsconfig.json and vite.config.ts aliases
- [ ] Update preflight checks in `scripts/preflight.cjs`
- [ ] Create route verification script
- [ ] Add environment validation

## 10) Test Infrastructure
- [ ] Create server test setup
- [ ] Create client test setup
- [ ] Add unit tests for core functions
- [ ] Add integration tests for API endpoints
- [ ] Add E2E tests for user workflows
- [ ] Configure coverage thresholds

## 11) Health & Monitoring
- [ ] Add /healthz endpoint
- [ ] Add /metrics endpoint (stub)
- [ ] Configure structured logging
- [ ] Add error tracking capabilities

## 12) CI/CD & Scripts
- [ ] Create `.github/workflows/ci.yml`
- [ ] Create `scripts/backup-db.sh`
- [ ] Update package.json scripts
- [ ] Add quality gates

## 13) Documentation
- [ ] Update `ARCHITECTURE.md`
- [ ] Create/update `API.md`
- [ ] Create/update `CONTRIBUTING.md`
- [ ] Create `MIGRATIONS.md`

## 14) Verification
- [ ] Run `npm run preflight` - passes
- [ ] Run `npm run check` - passes
- [ ] Run `npm test` - passes
- [ ] Run `npm run test:e2e` - passes
- [ ] All API endpoints return proper contracts
- [ ] Auth flow works end-to-end
- [ ] File uploads work securely
- [ ] Performance improvements verified
- [ ] Security headers present

## 15) Final Validation
- [ ] App boots successfully with /healthz = 200
- [ ] No unhandled promise rejections
- [ ] All routes protected properly
- [ ] CORS configured correctly for production
- [ ] Rate limiting active
- [ ] Logging working without secrets
- [ ] Environment variables documented