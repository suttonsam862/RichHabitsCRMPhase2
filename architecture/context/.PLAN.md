# Ultimate Rebuild & Production Hardening Plan

## Goal
Complete end-to-end production hardening and architectural rebuild to transform the barely functional application into a ship-ready, secure, performant system with:
- Full React Router v6 client routing with ErrorBoundary and AuthProvider
- Supabase Auth with role enforcement and protected routes
- Consolidated SQL migrations with idempotent DDL/seeds
- Standardized API contracts with unified error handling
- Secure file uploads with sanitization and MIME validation
- Performance optimizations (N+1 elimination via RPC)
- Comprehensive test coverage (unit/integration/E2E)
- Production security hardening (helmet, CORS, rate limiting)
- Health checks, metrics, logging, and CI/CD

## Files to be Created/Modified

### Database Migration
- `db/migrations/2025_08_22_ultimate_rebuild.sql` - Consolidated idempotent migration

### Server Infrastructure
- `server/env.ts` - Environment validation with Zod schema
- `server/lib/http.ts` - Standardized API response helpers
- `server/lib/log.ts` - Pino logging with redaction
- `server/lib/supabase.ts` - Supabase client helpers
- `server/middleware/auth.ts` - Authentication middleware with requireAuth
- `server/index.ts` - Express app with security middleware
- `server/routes/index.ts` - API v1 router with unified mounting
- `server/routes/auth/index.ts` - Auth endpoints (login/register/logout)
- `server/routes/organizations/index.ts` - Org CRUD with summary RPC
- `server/routes/users/index.ts` - User admin endpoints
- `server/routes/orders/index.ts` - Orders with statusCode only
- `server/routes/files/branding.ts` - Secure file upload endpoints

### Client Application
- `client/src/App.tsx` - React Router v6 with ErrorBoundary
- `client/src/routes.tsx` - Lazy route definitions
- `client/src/layouts/AppLayout.tsx` - Main layout component
- `client/src/components/ErrorBoundary.tsx` - Error boundary wrapper
- `client/src/auth/AuthProvider.tsx` - Supabase session management
- `client/src/auth/ProtectedRoute.tsx` - Route protection wrapper
- `client/src/lib/api.ts` - Unified API client with auth headers
- `client/src/lib/queryClient.ts` - TanStack Query configuration
- `client/src/pages/auth/LoginPage.tsx` - Login form with validation
- `client/src/pages/auth/RegisterPage.tsx` - Registration form
- `client/src/pages/organizations/List.tsx` - Org list with pagination
- `client/src/pages/organizations/CreateWizard.tsx` - 3-step org creation
- `client/src/pages/organizations/Detail.tsx` - Org detail with summary
- `client/src/pages/users/UsersPage.tsx` - User administration
- `client/src/pages/users/EditUserDrawer.tsx` - User editing interface
- `client/src/pages/quotes/QuotesPage.tsx` - Quotes functionality stub
- `client/src/pages/misc/NotFound.tsx` - 404 error page
- `client/src/components/OrgQuickViewDialog.tsx` - Org quick view modal
- `client/src/components/BrandingDropzone.tsx` - File upload component

### Configuration & Scripts
- `tsconfig.json` - Align path aliases
- `vite.config.ts` - Match tsconfig aliases
- `scripts/preflight.cjs` - Enhanced preflight checks
- `scripts/verify-routes.cjs` - Route verification script
- `scripts/backup-db.sh` - Database backup script
- `.github/workflows/ci.yml` - CI/CD pipeline

### Tests
- `server/tests/setup.ts` - Server test configuration
- `client/src/tests/setup.ts` - Client test configuration
- Unit, integration, and E2E test files
- `vitest.config.ts` - Test configuration with coverage

### Documentation
- `ARCHITECTURE.md` - Updated architecture documentation
- `API.md` - API v1 documentation
- `CONTRIBUTING.md` - Development workflow
- `MIGRATIONS.md` - Migration strategy documentation

## Risks & Mitigation
1. **Database Migration Risk**: Idempotent SQL ensures safe re-runs
2. **Breaking Changes**: Preserve existing data, use ON CONFLICT for seeds
3. **Auth Token Changes**: Gradual migration with backward compatibility
4. **Route Conflicts**: Verify no duplicate routes with script
5. **Performance Impact**: Use RPC to eliminate N+1 queries
6. **Security Gaps**: Comprehensive middleware stack and validation

## Rollback Plan
1. Database: Run `DROP` statements for new tables/columns if needed
2. Code: Git revert to previous commit
3. Auth: Revert to old session management if Supabase fails
4. Files: Restore from backup if corruption occurs
5. Performance: Disable RPC and revert to individual queries

## Implementation Sequence
1. Database migration and schema updates
2. Server infrastructure (env, logging, auth middleware)
3. API routes with standardized contracts
4. Client routing and authentication
5. UI components and pages
6. Test infrastructure and coverage
7. Security hardening and performance optimization
8. CI/CD and documentation
9. Verification and validation